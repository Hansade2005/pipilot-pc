<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PiPilot - Settings</title>
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Loosened CSP for development -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://pipilot.dev https://lzuknbfbvpuscpammwzg.supabase.co https://github.com https://translate.google.com https://translate.googleapis.com data: blob:;
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://pipilot.dev https://lzuknbfbvpuscpammwzg.supabase.co https://translate.google.com https://translate.googleapis.com;
                 frame-src 'self' https://pipilot.dev https://lzuknbfbvpuscpammwzg.supabase.co https://github.com https://translate.google.com;
                 style-src 'self' 'unsafe-inline' https:;">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      background: #f8f9fa;
    }

    .titlebar {
      height: 40px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      -webkit-app-region: drag;
      user-select: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .titlebar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .titlebar-logo {
      width: 24px;
      height: 24px;
    }
    .titlebar-title {
      color: white;
      font-size: 14px;
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .titlebar-center {
      flex: 1;
      text-align: center;
    }

    .titlebar-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      -webkit-app-region: no-drag;
    }

    .nav-item {
      color: white;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      padding: 8px 12px;
      border-radius: 4px;
      transition: background-color 0.2s ease;
      cursor: pointer;
      border: none;
      background: transparent;
    }

    .nav-item:hover {
      background: rgba(255,255,255,0.2);
    }

    .nav-dropdown {
      position: relative;
    }

    .nav-dropdown-btn {
      cursor: pointer;
    }

    .nav-dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1002;
      min-width: 120px;
    }

    .nav-dropdown-content.show {
      display: block;
    }

    .nav-dropdown-item {
      display: block;
      padding: 8px 12px;
      color: #333;
      text-decoration: none;
      transition: background-color 0.2s ease;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      cursor: pointer;
    }

    .nav-dropdown-item:hover {
      background-color: #f0f0f0;
    }

    .titlebar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    .titlebar-button {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }

    .titlebar-button:hover {
      background: rgba(255,255,255,0.2);
    }

    .titlebar-button.minimize:hover {
      background: rgba(255,255,255,0.3);
    }

    .titlebar-button.maximize:hover {
      background: rgba(255,255,255,0.3);
    }

    .titlebar-button.close:hover {
      background: rgba(255,0,0,0.8);
    }

    .theme-dropdown {
      position: relative;
      margin-right: 10px;
    }

    .theme-toggle {
      background: rgba(255,255,255,0.2) !important;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.3) !important;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: white;
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 1002;
      min-width: 160px;
    }

    .dropdown-item {
      display: block;
      padding: 8px 12px;
      color: #333;
      text-decoration: none;
      transition: background-color 0.2s ease;
    }

    .dropdown-item:hover {
      background-color: #f0f0f0;
    }

    .content {
      height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }

    .settings-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
    }

    .settings-header {
      margin-bottom: 30px;
      text-align: center;
    }

    .settings-title {
      font-size: 28px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .settings-subtitle {
      font-size: 16px;
      color: #6c757d;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .settings-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border: 1px solid #e9ecef;
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e9ecef;
    }

    .card-icon {
      width: 32px;
      height: 32px;
      margin-right: 12px;
      color: #667eea;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      margin: 0;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #495057;
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 14px;
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: 0.3s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: #667eea;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }

    .toggle-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
    }

    .toggle-text {
      font-size: 14px;
      color: #495057;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5a67d8;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .notification-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-text {
      font-size: 14px;
      color: #495057;
    }

    .avatar-upload {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .avatar-preview {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      font-size: 24px;
      font-weight: 600;
    }

    .avatar-input {
      display: none;
    }

    .avatar-label {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }

    .avatar-label:hover {
      background: #5a67d8;
    }

    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .theme-option {
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s ease;
    }

    .theme-option:hover {
      border-color: #667eea;
    }

    .theme-option.active {
      background: #667eea;
      border-color: #667eea;
    }

    .theme-name {
      color: #e0e0e0;
    }

    .notification-item {
      background: #2d3748;
      border: 1px solid #4a5568;
      color: #e0e0e0;
    }

    .backup-section {
      margin-top: 20px;
    }

    .backup-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #667eea;
      border-top: 3px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    .loading-text {
      color: #667eea;
      font-size: 16px;
      font-weight: 500;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Dark mode styles */
    @media (prefers-color-scheme: dark) {
      body {
        background: #1a1a1a;
        color: #e0e0e0;
      }

      .titlebar {
        background: linear-gradient(90deg, #2d3748 0%, #4a5568 100%);
      }

      .nav-dropdown-content,
      .dropdown-content {
        background: #2d3748;
        border: 1px solid #4a5568;
      }

      .nav-dropdown-item,
      .dropdown-item {
        color: #e0e0e0;
      }

      .nav-dropdown-item:hover,
      .dropdown-item:hover {
        background-color: #4a5568;
      }

      .settings-container {
        background: #2d3748;
        border: 1px solid #4a5568;
      }

      .settings-header {
        background: #2d3748;
      }

      .settings-title {
        color: #e0e0e0;
      }

      .settings-subtitle {
        color: #b0b0b0;
      }

      .settings-card {
        background: #2d3748;
        border: 1px solid #4a5568;
        color: #e0e0e0;
      }

      .card-header {
        border-bottom: 1px solid #4a5568;
      }

      .card-title {
        color: #e0e0e0;
      }

      .settings-section {
        border-bottom: 1px solid #4a5568;
      }

      .form-label {
        color: #e0e0e0;
      }

      .form-input,
      .form-textarea,
      .form-select {
        background: #1a1a1a;
        border: 1px solid #4a5568;
        color: #e0e0e0;
      }

      .form-input:focus,
      .form-textarea:focus,
      .form-select:focus {
        border-color: #667eea;
      }

      .avatar-preview {
        background: #4a5568;
        color: #e0e0e0;
      }

      .avatar-label {
        background: #667eea;
        color: #e0e0e0;
      }

      .avatar-label:hover {
        background: #5a67d8;
      }

      .toggle-text {
        color: #e0e0e0;
      }

      .btn {
        background: #4a5568;
        color: #e0e0e0;
      }

      .btn:hover {
        background: #667eea;
      }

      .btn.secondary {
        background: #2d3748;
        border: 1px solid #4a5568;
      }

      .btn.secondary:hover {
        background: #4a5568;
      }

      .btn-primary {
        background: #667eea;
        color: white;
      }

      .btn-primary:hover {
        background: #5a67d8;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-danger {
        background: #dc3545;
        color: white;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .theme-option {
        background: #2d3748;
        border: 1px solid #4a5568;
        color: #e0e0e0;
      }

      .theme-option:hover {
        background: #4a5568;
      }

      .theme-option.active {
        background: #667eea;
        border-color: #667eea;
      }

      .theme-name {
        color: #e0e0e0;
      }

      .language-option {
        background: #2d3748;
        border: 1px solid #4a5568;
        color: #e0e0e0;
      }

      .language-option:hover {
        background: #4a5568;
      }

      .language-option.active {
        background: rgba(102, 126, 234, 0.2);
        border-color: #667eea;
      }

      .language-name {
        color: #e0e0e0;
      }

      .notification-item {
        background: #2d3748;
        border: 1px solid #4a5568;
        color: #e0e0e0;
      }

      .notification-item:hover {
        background: #4a5568;
      }

      .notification-text {
        color: #e0e0e0;
      }

      .tab-content {
        background: #2d3748;
      }

      .tab-button.active {
        background: #4a5568;
      }

      .stats-grid {
        background: #2d3748;
        border: 1px solid #4a5568;
      }

      .backup-item {
        background: #2d3748;
        border: 1px solid #4a5568;
      }

      .backup-item:hover {
        background: #4a5568;
      }

      .loading-overlay {
        background: rgba(45, 55, 72, 0.9);
      }

      .loading-text {
        color: #e0e0e0;
      }

      .app-version-display {
        background: #2d3748 !important;
        border: 1px solid #4a5568;
        color: #e0e0e0;
      }
    }

    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }

      .settings-container {
        padding: 16px;
      }

      .backup-actions {
        flex-direction: column;
      }

      .backup-actions .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
  <div class="titlebar">
    <div class="titlebar-left">
      <img src="./assets/logo.png" alt="PiPilot" class="titlebar-logo">
      <div class="titlebar-title">PiPilot</div>
    </div>
    <div class="titlebar-center">
      <nav class="titlebar-nav">
        <button class="nav-item" onclick="loadPage('index.html')">Home</button>
        <button class="nav-item" onclick="loadPage('pc-workspace.html')">Workspace</button>
        <button class="nav-item" onclick="loadPage('pc-account.html')">Account</button>
        <div class="nav-dropdown">
          <button class="nav-item nav-dropdown-btn" onclick="toggleToolsDropdown()">Tools ▼</button>
          <div id="toolsDropdown" class="nav-dropdown-content">
            <button class="nav-dropdown-item" onclick="loadPage('pc-manage.html')">Manage</button>
            <button class="nav-dropdown-item" onclick="loadPage('pc-deploy.html')">Deploy</button>
            <button class="nav-dropdown-item" onclick="loadPage('pc-settings.html')">Settings</button>
          </div>
        </div>
      </nav>
    </div>
    <div class="titlebar-right">
      <div class="theme-dropdown" style="position: relative; margin-right: 10px;">
        <button class="titlebar-button theme-toggle" onclick="toggleThemeDropdown()">
          <i data-lucide="sun" id="theme-icon" style="width: 16px; height: 16px;"></i>
        </button>
        <div id="themeDropdown" class="dropdown-content" style="display: none; position: absolute; right: 0; top: 100%; background: white; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1002; min-width: 160px;">
          <a href="#" class="dropdown-item" onclick="setTheme('light')">Light Theme</a>
          <a href="#" class="dropdown-item" onclick="setTheme('dark')">Dark Theme</a>
          <a href="#" class="dropdown-item" onclick="setTheme('system')">System Theme</a>
        </div>
      </div>
      <button class="titlebar-button minimize" onclick="minimizeWindow()">─</button>
      <button class="titlebar-button maximize" id="maximizeBtn" onclick="toggleMaximize()">□</button>
      <button class="titlebar-button close" onclick="closeWindow()">✕</button>
    </div>
  </div>

  <div class="content">
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading Settings...</div>
    </div>

    <div class="settings-container">
      <div class="settings-header">
        <h1 class="settings-title">Settings</h1>
        <p class="settings-subtitle">Customize your PiPilot experience</p>
      </div>

      <div class="settings-grid">
        <!-- User Profile Card -->
        <div class="settings-card">
          <div class="card-header">
            <i data-lucide="user" class="card-icon"></i>
            <h3 class="card-title">User Profile</h3>
          </div>

          <div class="avatar-upload">
            <div class="avatar-preview" id="avatarPreview">U</div>
            <div>
              <input type="file" id="avatarInput" class="avatar-input" accept="image/*">
              <label for="avatarInput" class="avatar-label">Change Avatar</label>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="userName">Full Name</label>
            <input type="text" id="userName" class="form-input" placeholder="Enter your full name">
          </div>

          <div class="form-group">
            <label class="form-label" for="userEmail">Email Address</label>
            <input type="email" id="userEmail" class="form-input" placeholder="Enter your email">
          </div>

          <div class="form-group">
            <label class="form-label" for="userBio">Bio</label>
            <textarea id="userBio" class="form-textarea" placeholder="Tell us about yourself..."></textarea>
          </div>

          <button class="btn btn-primary" onclick="saveUserProfile()">
            <i data-lucide="save"></i>
            Save Profile
          </button>
        </div>

        <!-- Appearance Card -->
        <div class="settings-card">
          <div class="card-header">
            <i data-lucide="palette" class="card-icon"></i>
            <h3 class="card-title">Appearance</h3>
          </div>

          <div class="form-group">
            <label class="form-label">Theme</label>
            <div class="theme-grid">
              <div class="theme-option active" data-theme="light">
                <div style="width: 40px; height: 24px; background: linear-gradient(to right, #ffffff 50%, #f8f9fa 50%); border-radius: 4px; margin: 0 auto;"></div>
                <div class="theme-name">Light</div>
              </div>
              <div class="theme-option" data-theme="dark">
                <div style="width: 40px; height: 24px; background: linear-gradient(to right, #2d3748 50%, #1a202c 50%); border-radius: 4px; margin: 0 auto;"></div>
                <div class="theme-name">Dark</div>
              </div>
              <div class="theme-option" data-theme="system">
                <div style="width: 40px; height: 24px; background: linear-gradient(45deg, #ffffff 25%, #2d3748 25%, #2d3748 50%, #ffffff 50%, #ffffff 75%, #2d3748 75%); border-radius: 4px; margin: 0 auto;"></div>
                <div class="theme-name">System</div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Font Size</label>
            <select id="fontSize" class="form-input">
              <option value="small">Small</option>
              <option value="medium" selected>Medium</option>
              <option value="large">Large</option>
            </select>
          </div>
        </div>

        <!-- Notifications Card -->
        <div class="settings-card">
          <div class="card-header">
            <i data-lucide="bell" class="card-icon"></i>
            <h3 class="card-title">Notifications</h3>
          </div>

          <div class="toggle-label">
            <span class="toggle-text">Allow push notifications</span>
            <label class="toggle-switch">
              <input type="checkbox" id="allowPushNotifications" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <button class="btn btn-primary" onclick="saveNotificationSettings()">
            <i data-lucide="save"></i>
            Save Preferences
          </button>
        </div>

        <!-- Privacy & Security Card -->
        <div class="settings-card">
          <div class="card-header">
            <i data-lucide="shield" class="card-icon"></i>
            <h3 class="card-title">Privacy & Security</h3>
          </div>

          <div class="toggle-label">
            <span class="toggle-text">Analytics tracking</span>
            <label class="toggle-switch">
              <input type="checkbox" id="analyticsEnabled" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="toggle-label">
            <span class="toggle-text">Crash reporting</span>
            <label class="toggle-switch">
              <input type="checkbox" id="crashReporting" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="backup-section">
            <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #2c3e50;">Data Management</h4>
            <div class="backup-actions">
              <button class="btn btn-secondary" onclick="exportData()">
                <i data-lucide="download"></i>
                Export Data
              </button>
              <button class="btn btn-secondary" onclick="importData()">
                <i data-lucide="upload"></i>
                Import Data
              </button>
              <button class="btn btn-danger" onclick="clearAllData()">
                <i data-lucide="trash-2"></i>
                Clear All Data
              </button>
            </div>
          </div>
        </div>


        <!-- About & Support Card -->
        <div class="settings-card">
          <div class="card-header">
            <i data-lucide="info" class="card-icon"></i>
            <h3 class="card-title">About & Support</h3>
          </div>

          <div class="form-group">
            <label class="form-label">App Version</label>
            <div class="app-version-display" style="padding: 10px; background: #f8f9fa; border-radius: 6px; font-family: monospace;">
              PiPilot v1.0.0 (Build 2025.11.04)
            </div>
          </div>

          <div class="backup-actions">
            <button class="btn btn-secondary" onclick="checkForUpdates()">
              <i data-lucide="refresh-cw"></i>
              Check for Updates
            </button>
            <button class="btn btn-secondary" onclick="openHelp()">
              <i data-lucide="help-circle"></i>
              Help & Support
            </button>
            <button class="btn btn-secondary" onclick="openFeedback()">
              <i data-lucide="message-square"></i>
              Send Feedback
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Google Translate Element -->
  <div id="google_translate_element" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;"></div>

  <script type="text/javascript">
  function googleTranslateElementInit() {
    try {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'en,es,fr',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    } catch (error) {
      console.error('Google Translate widget initialization error:', error);
    }
  }
  
  // Fallback in case the callback isn't triggered
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof google === 'undefined' || !google.translate) {
      // Try to load the script dynamically
      var script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
      script.onerror = function() {
        console.error('Failed to load Google Translate script');
      };
      document.head.appendChild(script);
    }
  });
  </script>
  <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

  <script>
    // IndexedDB setup and management
    class PiPilotDB {
      constructor() {
        this.dbName = 'PiPilotDB';
        this.version = 1;
        this.db = null;
      }

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.dbName, this.version);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.db = request.result;
            resolve(this.db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;

            // User profile store
            if (!db.objectStoreNames.contains('userProfile')) {
              const userStore = db.createObjectStore('userProfile', { keyPath: 'id' });
              userStore.createIndex('email', 'email', { unique: true });
            }

            // Settings store
            if (!db.objectStoreNames.contains('settings')) {
              db.createObjectStore('settings', { keyPath: 'key' });
            }

            // Projects store
            if (!db.objectStoreNames.contains('projects')) {
              const projectStore = db.createObjectStore('projects', { keyPath: 'id', autoIncrement: true });
              projectStore.createIndex('name', 'name', { unique: false });
              projectStore.createIndex('created', 'created', { unique: false });
            }

            // Analytics store
            if (!db.objectStoreNames.contains('analytics')) {
              db.createObjectStore('analytics', { keyPath: 'id', autoIncrement: true });
            }
          };
        });
      }

      async saveUserProfile(profile) {
        const transaction = this.db.transaction(['userProfile'], 'readwrite');
        const store = transaction.objectStore('userProfile');
        return new Promise((resolve, reject) => {
          const request = store.put({ ...profile, id: 'current' });
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      }

      async getUserProfile() {
        const transaction = this.db.transaction(['userProfile'], 'readonly');
        const store = transaction.objectStore('userProfile');
        return new Promise((resolve, reject) => {
          const request = store.get('current');
          request.onsuccess = () => resolve(request.result || {});
          request.onerror = () => reject(request.error);
        });
      }

      async saveSetting(key, value) {
        const transaction = this.db.transaction(['settings'], 'readwrite');
        const store = transaction.objectStore('settings');
        return new Promise((resolve, reject) => {
          const request = store.put({ key, value });
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      }

      async getSetting(key) {
        const transaction = this.db.transaction(['settings'], 'readonly');
        const store = transaction.objectStore('settings');
        return new Promise((resolve, reject) => {
          const request = store.get(key);
          request.onsuccess = () => resolve(request.result ? request.result.value : null);
          request.onerror = () => reject(request.error);
        });
      }

      async getAllSettings() {
        const transaction = this.db.transaction(['settings'], 'readonly');
        const store = transaction.objectStore('settings');
        return new Promise((resolve, reject) => {
          const request = store.getAll();
          request.onsuccess = () => {
            const settings = {};
            request.result.forEach(item => {
              settings[item.key] = item.value;
            });
            resolve(settings);
          };
          request.onerror = () => reject(request.error);
        });
      }

      async clearAllData() {
        const stores = ['userProfile', 'settings', 'projects', 'analytics'];
        const promises = stores.map(storeName => {
          return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.clear();
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        });
        return Promise.all(promises);
      }
    }

    // Global database instance
    const db = new PiPilotDB();

    // Initialize the app
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await db.init();
        await loadSettings();
        await loadUserProfile();
        hideLoading();
        lucide.createIcons();
        
        // Initialize theme icon
        await updateThemeIcon();
      } catch (error) {
        console.error('Failed to initialize app:', error);
        showNotification('Error initializing app. Please refresh.', 'error');
      }
    });

    // Load user profile from database
    async function loadUserProfile() {
      try {
        const profile = await db.getUserProfile();
        if (profile.name) document.getElementById('userName').value = profile.name;
        if (profile.email) document.getElementById('userEmail').value = profile.email;
        if (profile.bio) document.getElementById('userBio').value = profile.bio;

        if (profile.avatar) {
          document.getElementById('avatarPreview').style.backgroundImage = `url(${profile.avatar})`;
          document.getElementById('avatarPreview').textContent = '';
        } else {
          const name = profile.name || 'U';
          document.getElementById('avatarPreview').textContent = name.charAt(0).toUpperCase();
        }
      } catch (error) {
        console.error('Failed to load user profile:', error);
      }
    }

    // Save user profile to database
    async function saveUserProfile() {
      try {
        const profile = {
          name: document.getElementById('userName').value.trim(),
          email: document.getElementById('userEmail').value.trim(),
          bio: document.getElementById('userBio').value.trim(),
          updatedAt: new Date().toISOString()
        };

        await db.saveUserProfile(profile);
        
        // Send the profile data to the main process
        if (window.electronAPI) {
          window.electronAPI.send('update-user-profile-data', profile);
        }
        
        showNotification('Profile saved successfully!', 'success');
      } catch (error) {
        console.error('Failed to save profile:', error);
        showNotification('Failed to save profile. Please try again.', 'error');
      }
    }

    // Load settings from database
    async function loadSettings() {
      try {
        const settings = await db.getAllSettings();

        // Theme - determine from Electron theme state
        let currentTheme = 'system'; // default
        if (window.darkMode) {
          const themeInfo = await window.darkMode.getTheme();
          if (themeInfo.themeSource === 'dark') {
            currentTheme = 'dark';
          } else if (themeInfo.themeSource === 'light') {
            currentTheme = 'light';
          } else {
            currentTheme = 'system';
          }
        }
        setActiveTheme(currentTheme);

        // Font size
        const fontSize = settings.fontSize || 'medium';
        document.getElementById('fontSize').value = fontSize;

        // Notifications
        document.getElementById('allowPushNotifications').checked = settings.allowPushNotifications !== false;

        // Privacy
        document.getElementById('analyticsEnabled').checked = settings.analyticsEnabled !== false;
        document.getElementById('crashReporting').checked = settings.crashReporting !== false;
      } catch (error) {
        console.error('Failed to load settings:', error);
      }
    }

    // Save notification settings
    async function saveNotificationSettings() {
      try {
        const settings = {
          allowPushNotifications: document.getElementById('allowPushNotifications').checked
        };

        for (const [key, value] of Object.entries(settings)) {
          await db.saveSetting(key, value);
        }

        showNotification('Notification preferences saved!', 'success');
      } catch (error) {
        console.error('Failed to save notification settings:', error);
        showNotification('Failed to save preferences. Please try again.', 'error');
      }
    }

    // Theme selection
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', async () => {
        const theme = option.dataset.theme;
        setActiveTheme(theme);
        
        // Also update the Electron theme
        if (window.darkMode) {
          if (theme === 'system') {
            await window.darkMode.system();
          } else {
            const currentTheme = await window.darkMode.getTheme();
            let needsToggle = false;
            
            if (theme === 'dark' && !currentTheme.shouldUseDarkColors) {
              needsToggle = true;
            } else if (theme === 'light' && currentTheme.shouldUseDarkColors) {
              needsToggle = true;
            }
            
            if (needsToggle) {
              await window.darkMode.toggle();
            }
          }
        }
        
        // Update the theme icon
        setTimeout(updateThemeIcon, 100);
        
        showNotification(`Theme changed to ${theme}!`, 'success');
      });
    });

    function setActiveTheme(theme) {
      document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.toggle('active', opt.dataset.theme === theme);
      });
    }

    // Avatar upload
    document.getElementById('avatarInput').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const avatarData = e.target.result;
          document.getElementById('avatarPreview').style.backgroundImage = `url(${avatarData})`;
          document.getElementById('avatarPreview').textContent = '';

          try {
            const profile = await db.getUserProfile();
            await db.saveUserProfile({ ...profile, avatar: avatarData });
            showNotification('Avatar updated successfully!', 'success');
          } catch (error) {
            console.error('Failed to save avatar:', error);
            showNotification('Failed to save avatar. Please try again.', 'error');
          }
        };
        reader.readAsDataURL(file);
      }
    });

    // Data management functions
    async function exportData() {
      try {
        const data = {
          userProfile: await db.getUserProfile(),
          settings: await db.getAllSettings(),
          exportDate: new Date().toISOString()
        };

        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `pipilot-backup-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showNotification('Data exported successfully!', 'success');
      } catch (error) {
        console.error('Failed to export data:', error);
        showNotification('Failed to export data. Please try again.', 'error');
      }
    }

    async function importData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (event) => {
        const file = event.target.files[0];
        if (file) {
          try {
            const text = await file.text();
            const data = JSON.parse(text);

            if (data.userProfile) await db.saveUserProfile(data.userProfile);
            if (data.settings) {
              for (const [key, value] of Object.entries(data.settings)) {
                await db.saveSetting(key, value);
              }
            }

            await loadSettings();
            await loadUserProfile();
            showNotification('Data imported successfully!', 'success');
          } catch (error) {
            console.error('Failed to import data:', error);
            showNotification('Failed to import data. Invalid file format.', 'error');
          }
        }
      };
      input.click();
    }

    async function clearAllData() {
      if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
        try {
          await db.clearAllData();
          // Reset form fields
          document.getElementById('userName').value = '';
          document.getElementById('userEmail').value = '';
          document.getElementById('userBio').value = '';
          document.getElementById('avatarPreview').style.backgroundImage = '';
          document.getElementById('avatarPreview').textContent = 'U';

          await loadSettings(); // This will reset to defaults
          showNotification('All data cleared successfully!', 'success');
        } catch (error) {
          console.error('Failed to clear data:', error);
          showNotification('Failed to clear data. Please try again.', 'error');
        }
      }
    }

    // Utility functions
    function showNotification(message, type = 'info') {
      // Simple notification - you could enhance this with a proper notification system
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;

      if (type === 'success') {
        notification.style.background = '#28a745';
      } else if (type === 'error') {
        notification.style.background = '#dc3545';
      } else {
        notification.style.background = '#667eea';
      }

      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // Placeholder functions for future implementation
    function checkForUpdates() {
      showNotification('Checking for updates...', 'info');
      setTimeout(() => {
        showNotification('You are running the latest version!', 'success');
      }, 2000);
    }

    function openHelp() {
      showNotification('Help & Support coming soon!', 'info');
    }

    function openFeedback() {
      showNotification('Feedback form coming soon!', 'info');
    }

    // Navigation functions
    function loadPage(page) {
      try {
        window.location.href = page;
      } catch (error) {
        console.error('Error loading page:', error);
      }
    }

    function toggleToolsDropdown() {
      const dropdown = document.getElementById('toolsDropdown');
      if (dropdown) {
        dropdown.classList.toggle('show');
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (event) => {
      const dropdown = document.getElementById('toolsDropdown');
      const button = event.target.closest('.nav-dropdown-btn');
      if (dropdown && !button && !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });

    // Theme functions (inherited from other pages)
    function toggleThemeDropdown() {
      const dropdown = document.getElementById('themeDropdown');
      if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      }
    }

    async function setTheme(theme) {
      try {
        if (window.darkMode) {
          if (theme === 'system') {
            await window.darkMode.system();
          } else {
            // Get current theme to determine if we need to toggle
            const currentTheme = await window.darkMode.getTheme();
            let needsToggle = false;
            
            if (theme === 'dark' && !currentTheme.shouldUseDarkColors) {
              needsToggle = true;
            } else if (theme === 'light' && currentTheme.shouldUseDarkColors) {
              needsToggle = true;
            }
            
            if (needsToggle) {
              await window.darkMode.toggle();
            }
          }
          
          // Close the dropdown after selection
          document.getElementById('themeDropdown').style.display = 'none';
          
          // Update the theme icon
          setTimeout(updateThemeIcon, 100); // slight delay to ensure theme is applied
        }
      } catch (error) {
        console.error('Error setting theme:', error);
      }
    }

    async function updateThemeIcon() {
      try {
        if (window.darkMode) {
          const themeInfo = await window.darkMode.getTheme();
          const iconElement = document.getElementById('theme-icon');
          
          if (iconElement) {
            if (themeInfo.themeSource === 'dark' || 
                (themeInfo.themeSource === 'system' && themeInfo.shouldUseDarkColors)) {
              iconElement.setAttribute('data-lucide', 'moon');
            } else {
              iconElement.setAttribute('data-lucide', 'sun');
            }
            setTimeout(() => {
              lucide.createIcons(); // Reinitialize icons after setting the attribute
            }, 0);
          }
        }
      } catch (error) {
        console.error('Error updating theme icon:', error);
      }
    }

    // Window control functions
    function minimizeWindow() {
      if (window.electronAPI && window.electronAPI.minimizeWindow) {
        window.electronAPI.minimizeWindow();
      }
    }

    function toggleMaximize() {
      if (window.electronAPI && window.electronAPI.toggleMaximize) {
        window.electronAPI.toggleMaximize();
      }
    }

    function closeWindow() {
      if (window.electronAPI && window.electronAPI.closeWindow) {
        window.electronAPI.closeWindow();
      }
    }

    function hideLoading() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }
  </script>
</body>
</html>